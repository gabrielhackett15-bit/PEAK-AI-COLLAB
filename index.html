<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omni-Bridge | Centurion v13.8.5</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        .min-h-dvh { min-height: 100dvh; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const THEMES = {
            GPT: { color: 'bg-emerald-500', text: 'text-emerald-400', border: 'border-emerald-500/20' },
            GEMINI: { color: 'bg-blue-500', text: 'text-blue-400', border: 'border-blue-500/20' },
            CLAUDE: { color: 'bg-amber-500', text: 'text-amber-400', border: 'border-amber-500/20' }
        };

        function App() {
            const [mode, setMode] = useState('GPT');
            const [url, setUrl] = useState('');
            const [models, setModels] = useState([]);
            const [selected, setSelected] = useState('');
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            const theme = THEMES[mode];

            useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages]);

            const sync = async () => {
                if (!url) return;
                setLoading(true);
                try {
                    // Normalize URL: remove trailing slash
                    const cleanUrl = url.replace(/\/+$/, "");
                    const res = await fetch(`${cleanUrl}/v1/models`);
                    const text = await res.text();
                    
                    try {
                        const data = JSON.parse(text);
                        setModels(data.data || []);
                        if (data.data?.length) setSelected(data.data[0].id);
                    } catch (parseErr) {
                        console.error("Raw response:", text);
                        throw new Error("Worker returned non-JSON. Check your Worker URL.");
                    }
                } catch (err) {
                    setMessages(prev => [...prev, { role: 'assistant', content: `SYNC ERROR: ${err.message}` }]);
                } finally { setLoading(false); }
            };

            const send = async () => {
                if (!input.trim() || !url) return;
                const newMsgs = [...messages, { role: 'user', content: input }];
                setMessages(newMsgs);
                setInput('');
                
                try {
                    const cleanUrl = url.replace(/\/+$/, "");
                    const res = await fetch(`${cleanUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model: selected, messages: newMsgs })
                    });
                    const data = await res.json();
                    setMessages(prev => [...prev, { role: 'assistant', content: data.choices?.[0]?.message?.content || data.error }]);
                } catch (err) {
                    setMessages(prev => [...prev, { role: 'assistant', content: `REQUEST ERROR: ${err.message}` }]);
                }
            };

            return (
                <div className="min-h-dvh flex flex-col transition-colors duration-500">
                    <header className={`p-4 border-b ${theme.border} flex justify-between items-center bg-slate-900/50 backdrop-blur-md`}>
                        <div className="flex items-center gap-2">
                            <div className={`w-2.5 h-2.5 rounded-full ${theme.color} animate-pulse`} />
                            <h1 className="font-black italic tracking-tighter text-lg uppercase">OMNI-BRIDGE</h1>
                        </div>
                        <div className="flex gap-1">
                            {['GPT', 'GEMINI', 'CLAUDE'].map(t => (
                                <button key={t} onClick={() => setMode(t)} className={`px-3 py-1 rounded text-[10px] font-bold ${mode === t ? theme.color : 'bg-slate-800 text-slate-500'}`}>{t}</button>
                            ))}
                        </div>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 space-y-4 pb-48 no-scrollbar">
                        {messages.length === 0 && (
                            <div className="h-64 flex flex-col items-center justify-center opacity-20 text-center">
                                <div className={`w-12 h-12 border-2 ${theme.border} rounded-full mb-4`} />
                                <p className="text-xs font-bold tracking-[0.4em]">CENTURION STANDBY</p>
                            </div>
                        )}
                        {messages.map((m, i) => (
                            <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[90%] p-4 rounded-2xl text-sm ${m.role === 'user' ? 'bg-slate-800' : `bg-slate-900 border ${theme.border}`}`}>
                                    {m.content}
                                </div>
                            </div>
                        ))}
                        <div ref={scrollRef} />
                    </main>

                    <footer className={`fixed bottom-0 left-0 right-0 p-4 bg-slate-950/90 backdrop-blur-xl border-t ${theme.border} space-y-3`}>
                        <div className="flex gap-2">
                            <input value={url} onChange={e => setUrl(e.target.value)} placeholder="Worker URL..." className="flex-1 bg-slate-900 border border-slate-800 rounded px-3 py-1.5 text-[10px] outline-none font-mono" />
                            <button onClick={sync} className="bg-slate-800 px-3 py-1.5 rounded text-[10px] font-bold uppercase">{loading ? '...' : 'Sync'}</button>
                        </div>
                        <select value={selected} onChange={e => setSelected(e.target.value)} className="w-full bg-slate-900 border border-slate-800 rounded px-2 py-1.5 text-[10px] font-bold outline-none">
                            {models.length ? models.map(m => <option key={m.id} value={m.id}>{m.id}</option>) : <option>No Models</option>}
                        </select>
                        <div className="flex gap-2">
                            <textarea value={input} onChange={e => setInput(e.target.value)} placeholder="Command..." className="flex-1 bg-slate-900 border border-slate-800 rounded-xl p-3 text-sm h-12 resize-none outline-none focus:border-slate-600" onKeyDown={e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), send())} />
                            <button onClick={send} className={`p-3 rounded-xl ${theme.color} text-white shadow-lg`}><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M22 2 11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg></button>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

